# puppetlabs-pe_status_check

- [puppetlabs-pe_status_check](#puppetlabs-pe_status_check)
  - [Description](#description)
  - [Setup](#setup)
    - [What pe_status_check affects](#what-pe_status_check-affects)
    - [Setup Requirements](#setup-requirements)
    - [Beginning with pe_status_check](#beginning-with-pe_status_check)
  - [Usage](#usage)
    - [Class Declaration *Optional.*](#class-declaration-optional)
  - [Reference](#reference)
  - [Fact: pe_status_check](#fact-pe_status_check)
  - [Fact: agent_status_check](#fact-agent_status_check)
  - [How to Report an issue or contribute to the module](#how-to-report-an-issue-or-contribute-to-the-module)

## Description

puppetlabs-pe_status_check aims to provide a mechanism to alert the end-user when Puppet Enterprise is not in an ideal state.
It uses pre-set indicators and has a simplified output that directs the end-user to next steps for resolution.

Users of the tool should expect greater ability to provide the self served resolutions, as well as shorter incident resolution times with Puppet Enterprise Support due to higher quality information available to support cases.

## Setup

### What pe_status_check affects

This module installs a structured fact named pe_status_check, which contains an array of key pairs tha simply output an indicator ID and a boolean value. This fact is confined to Puppet Enterprise infrastructure agents only
A second fact named agent_status_check contains indicators targetted at only normal agent nodes.

### Setup Requirements

Plugin-Sync should be enabled to deliver the facts this module requires

### Beginning with pe_status_check

puppetlabs-pe_status_check primarily provides the indicators by means of facts so installing the module and allowing plugin sync to occur will allow the module to start functioning

## Usage

The Facts contained in this module can be used for direct consumption by monitoring tools such as Splunk, any element in the structured fact `pe_status_check` or `agent_status_check` reporting as "false" indicates a fault state in Puppet Enterprise.
When any of the elements reports as false, the incident ID should be looked up in the reference section for next steps

Alternatively, assigning the class pe_status_check to the infrastructure will "Notify" on each Puppet run if any of the indicators are in a fault state.

### Class Declaration *Optional.*

To activate the notification functions of this module, classify your Puppet Infrastructure  with the pe_status_check class using your preferred classification method. Below is an example using site.pp.

```puppet
node 'node.example.com' {
  include pe_status_check
}
```

While the entirety of the default indicators should be reported on for maximum coverage, it may be necessary to make exceptions for your particular environment.
to do this classify the array parameter indicator_exclusions with an list of all indicators you do not want to report on.

This workflow is not available for the agent_status_check fact.

```puppet
class { 'pe_status_check':
  indicator_exclusions             => ['S0001','S0003','S0003','S0004'],
}
```

## Reference

This section should be referred to for next steps when any indicator reports a fault


## Fact: pe_status_check


| Indicator ID | Description                                                                        | Self Service Steps                                                                                                                                                                                                                                                                                                                                                                                                                                                          | What to Include in a Support Ticket                                                                                                                                                                                                   |
|--------------|------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| S0001        | Determines if Puppet agent Service is running                                      | Start the puppet agent - `puppet resource service puppet ensure=running`                                                                                                                                                                                                                                                                                                                                                                                                    | If the Puppet agent fails to start with the self service step raise a support case quoting reference S0001 and providing `syslog` and any error output when attempting to restart the service                                           |
| S0002        | Determines if pxp-agent Service is running                                         | Start the pxp-agent - `puppet resource service pxp-agent ensure=running`                                                                                                                                                                                                                                                                                                                                                                                                    | If the Pxp-agent fails to start with the self service step raise a support case quoting reference S0002 and providing `syslog`, any error output when attempting to restart the service and `/var/log/puppetlabs/pxp-agent/pxp-agent.log` |
| S0003        | Determines if Infrastructure components are running in NOOP                        | Noop should not be routinely configured on PE infrastructure nodes as it prevents the management of key infrastructure settings. Please disable this setting on any infrastructure component <https://puppet.com/docs/puppet/7/configuration.html#noop>                                                                                                                                                                                                                       | If you are unable, or encounter an error when disabling noop, raise a support case quoting reference S0003 and any errors output when attempting to change the setting                                                                |
| S0004        | Determines if infrastructure status is not green                                   | Run the command `puppet infrastructure status` on your primary node, note any services showing in an error state and examine the corresponding service logs for potential causes                                                                                                                                                                                                                                                                                            | Raise a support case quoting reference S0004 along with the output of puppet infrastructure status and any service logs associated with the errors                                                                                    |
| S0005        | Determines if CA expires within 90 days                                            | Install the following module <https://forge.puppet.com/modules/puppetlabs/ca_extend> and follow the documentation to extend the CA                                                                                                                                                                                                                                                                                                                                            | Raise a support case quoting reference S0005 together with the [Support Script](https://puppet.com/docs/pe/2021.4/getting_support_for_pe.html#pe_support_script) output from the primary node, and any errors encountered when using the ca_extend module                                                                |
| S0006        | Determines if Puppet Metrics Collector is Enabled and collecting Metrics                     |Metrics collector is a vital tool to the allow proper monitoring of a PE installation. If it is not enabled do so by consulting the following [documentation](https://puppet.com/docs/pe/2021.4/getting_support_for_pe.html#puppet_metrics_collector)  | If you are having difficulty enabling the metrics, raise a ticket quoting S0006 providing the output of the [Support Script](https://puppet.com/docs/pe/2021.4/getting_support_for_pe.html#pe_support_script)                                   |
| S0007        | Determines if there is at least 20% disk free on postgres Data partition           | Determine if the growth is slow and expected within the TTL of your data, unexpected increase can be due to error states this article should be consulted <https://support.puppet.com/hc/en-us/articles/360056219974>                                                                                                                                                                                                  | Raise a support case quoting reference S0007 detailing the files and folders and rate of growth, along with a full [Support Script](https://puppet.com/docs/pe/2021.4/getting_support_for_pe.html#pe_support_script) from the node in question                                                                           |
| S0008        | Determines if there is at least 20% disk free on the Codedir Data Partition        | This can indicate you are deploying more code from the code repo than there is space for on the infrastructure components, or something else is consuming space on this partition. Check the mount that the directory indicated by `puppet config print codedir` resides has enough capacity for the code being deployed, and check no other outside files are consuming this data mount                                                                                    |                                                                                                                                                                                                                                       |
| S0009        | Determines if Pe-puppetsever Service is Running and Enabled on relevant components | Check the Service can be started and enabled  `puppet resource service pe-puppetserver ensure=running` examining `/var/log/puppetlabs/puppetserver/puppetserver.log` for failures                                                                                                                                                                                                                                                                                               | Raise a support case quoting reference S0009 along with the log below, showing an unsuccessful startup `/var/log/puppetlabs/puppetserver/puppetserver.log`                                                                              |
| S0010        | Determines if Pe-puppetdb Service is Running and Enabled on relevant components    | Check the Service can be started and enabled   `puppet resource service pe-pupeptdb ensure=running`  examining `/var/log/puppetlabs/puppetdb/puppetdb.log` for failures                                                                                                                                                                                                                                                                                                         | Raise a support case quoting reference S0010 along with the log below, showing an unsuccessful startup `/var/log/puppetlabs/puppetdb/puppetdb.log`                                                                                      |
| S0011        | Determines if Pe-postgres Service is Running and Enabled on relevant components    | Check the Service can be started and enabled   `puppet resource service pe-postgres ensure=running`  examining `/var/log/puppetlabs/postgresql/<postgresversion>/postgresql-<today>.log` for failures                                                                                                                                                                                                                                                                           | Raise a support case quoting reference S0011 along with the log below, showing an unsuccessful startup /var/log/puppetlabs/postgresql/<postgresversion>/ postgresql-<today>.log                                                       |
| S0012        | Determines if Puppet produced a report within the last run interval                | <https://puppet.com/docs/pe/2021.4/run_puppet_on_nodes.html#troubleshooting_puppet_run_failures>                                                                                                                                                                                                                                                                                                                                                                              | Raise a support case quoting reference S0012 along with the output of `puppet agent -td > debug.log 2>&1`                                                                                                                             |
| S0013        | Determines if a catalog successfully applied on Puppet Agent Last run              | <https://puppet.com/docs/pe/2021.4/run_puppet_on_nodes.html#troubleshooting_puppet_run_failures>                                                                                                                                                                                                                                                                                                                                                                              | Raise a support case quoting reference S0013 along with the output of  `puppet agent -td > debug.log 2>&1`                                                                                                                            |
| S0014        | Indicates nothing in the command queue is older than a Puppet Run Interval         | This can indicate that the PuppetDB performance is inadequate for the incoming requests. Review the PuppetDB Performance. Metrics can be used to pinpoint the issue https://support.puppet.com/hc/en-us/articles/231751308 | Raise a support case quoting reference `S0014` along with the output of the [Support Script](https://puppet.com/docs/pe/2021.4/getting_support_for_pe.html#pe_support_script)  |
| S0016        | Determine if there are any `OutOfMemory` errors in the `puppetserver`. | https://support.puppet.com/hc/en-us/articles/360015511413 | Raise a support case quoting reference S0016 along with puppet metrics: https://support.puppet.com/hc/en-us/articles/231751308, `puppetserver.log` and output of `puppet infra tune`.|
| S0017        | Determine if there are any `OutOfMemory` errors in the `puppetdb`. | https://support.puppet.com/hc/en-us/articles/360015511413 | Raise a support case quoting reference S0017 along with puppet metrics: https://support.puppet.com/hc/en-us/articles/231751308, `puppetdb.log` and output of `puppet infra tune`.|
| S0018        | Determine if there are any `OutOfMemory` errors in the `orchestrator`. | https://support.puppet.com/hc/en-us/articles/360015511413 | Raise a support case quoting reference S0018 along with puppet metrics: https://support.puppet.com/hc/en-us/articles/231751308, `orchestration-services.log` and output of `puppet infra tune`.|
|S0019|Determines if there are sufficent jrubies available to serve agents| Insufficent jruby availability will result in queued puppet agents and overall poor system performance. There can be many causes; [Insufficent server tuning for load](https://support.puppet.com/hc/en-us/articles/360013148854-Get-optimized-performance-settings-in-Puppet-Enterprise-2018-1-and-later), [A thundering herd](https://support.puppet.com/hc/en-us/articles/215729277-Determine-a-thundering-herd-condition-in-Puppet-Enterprise-3-0-and-later), [insufficient system resources for scale](https://puppet.com/docs/pe/latest/hardware_requirements.html#hardware_requirements) | Should the self sevice path fail to resolve the issue, open a ticket quoting reference S0019 with a description of actions so far and the output of the [Support Script](https://puppet.com/docs/pe/2021.4/getting_support_for_pe.html#pe_support_script)
|S0021|Determines if there if free memory is less than 10%| Ensure your system hardware availablity matches the [recommended configuration](https://puppet.com/docs/pe/latest/hardware_requirements.html#hardware_requirements), please note this assumes there is no 3rd party software using significant resource, adapt requirements accordingly for 3rd party requirements | Should you be experiancing issues with memory utilisation on the Puppet Enterprise platform that is not expected, raise a support case, quoting ID S0021 alogn with the output of the [Support Script](https://puppet.com/docs/pe/2021.4/getting_support_for_pe.html#pe_support_script)
| S0022        | Determines if there is a valid Puppet Enterprise license in place at `/etc/puppetlabs/license.key` on your primary which is not going to expire in the next 90 days                | <https://support.puppet.com/hc/en-us/articles/360017933313>                                                                                                                                                                                                                                                                                                                                                                              | Raise a support case quoting reference S0022 along with the output of the following commands `ls -la /etc/puppetlabs/license.key` and `cat /etc/puppetlabs/license.key`. |
| S0030        | Determines when infrastructure components that run with the setting use_cached_catalog are set to true                        | Don't configure use_cached_catalog on PE infrastructure nodes. It prevents the management of key infrastructure settings. Disable this setting on any infrastructure component. See: <https://puppet.com/docs/puppet/7/configuration.html#use-cached-catalog>                                                                                                                                                                                                                       | Submit a support case when you encounter an error after disabling use_cached_catalog. Reference S0030 and include output errors that appeared when you attempted to change the setting
| S0031        | Determines if old PE agent packages still exist on the Primary server | Please follow the KB article to remove the old PE agent packages <https://support.puppet.com/hc/en-us/articles/4405333422103> |
| S0033        | Determines if modern Hiera 5 is in use | Upgrading to Hiera 5 offers some major advantages <https://puppet.com/docs/puppet/7/hiera_migrate>                                                                                                                           | If you're running into issues upgrading to Hiera 5 or believe your Global Hiera configuration file was erroneously modified, raise a support case quoting reference S0033. Provide your Global Hiera Configuration file `puppet config print hiera_config`; the default location is `/etc/puppetlabs/puppet/hiera.yaml`.
| S0034        | Determines if PE software is more than 1 year old                   | Please refer to https://puppet.com/docs/pe/2021.4/upgrading_pe.html for instructions on how to upgrade your PE instance                                                                                                                | If you need advice on upgrading PE  - Please raise a ticket with the version of PE you are currently running and the version you would like to upgrade to (this could be the LTS or STS version of PE). |
| S0036        | Determines if max-queued-requests is set above 150                       | The maximum value for `jruby_puppet_max_queued_requests` is 150                (<https://support.puppet.com/hc/en-us/articles/115003769433>)                                                                      | If you are unable, or encounter an error when changing the value of `jruby_puppet_max_queued_requests`, raise a support case quoting reference S0036 and any errors output when attempting to change the setting
| S0039        | If puppetserver has a non zero queue-limit-hit-rate, Puppetserver will send 503 error messages. | Please refer the Knowledge article https://support.puppet.com/hc/en-us/articles/115003769433                     | Raise a support case quoting reference S0039 together with the [Support Script](https://puppet.com/docs/pe/2021.4/getting_support_for_pe.html#pe_support_script) output from the primary node
| S0040        | Determines if you collecting system metrics                    | Refer to the following documentation when setting up system metrics: <https://forge.puppet.com/modules/puppetlabs/puppet_metrics_collector#installation>                                                                     | Raise a support request, if after system metrics are configured and you do not see any files in /var/log/sa or if /var/log/sa directory does not exist.                                                 |


## Fact: agent_status_check

| Indicator ID | Description                                                                        | Self Service Steps                                                                                                                                                                                                                                                                                                                                                                                                                                                          | What to Include in a Support Ticket                                                                                                                                                                                                   |
|--------------|------------------------------------------------------------------------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| AS001        | Determines if the agent host certificate is expiring within 90 days                                     | Puppet Enterprise has a plan built into extend agent certificates. Using a puppet query to find expiring host certificates and pass the node ID to this plan is recommended:   `puppet plan run enterprise_tasks::agent_cert_regen agent=$(puppet query 'inventory[certname] { facts.agent_self_service.AS001 = true }' \| jq  -r '.[].certname' \|  paste -sd, -) master=$(puppet config print certname)`                                                                                   | If the plan fails to run, open a support ticket quoting AS001 along with the copy of the error message recieved when running the plan.



## How to Report an issue or contribute to the module

If you are a PE user and need support using this module or are encountering issues, our Support team would be happy to help you resolve your issue and help reproduce any bugs. Just raise a ticket on the [support portal](https://support.puppet.com/hc/en-us/requests/new).
 If you have a reproducible bug or are a community user you can raise it directly on the Github issues page of the module [here](https://github.com/puppetlabs/puppetlabs-pe_status_check/issues). We also welcome PR contributions to improve the module. Please see further details about contributing [here](https://puppet.com/docs/puppet/7.5/contributing.html#contributing_changes_to_module_repositories).